<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Election Voting</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --light: #f3f4f6;
      --dark: #1f2937;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    
    h1 {
      margin-top: 20px;
      font-size: 2.5rem;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: fadeInDown 0.8s ease-out;
    }
    
    .card {
      background: #fff;
      color: var(--dark);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      margin-top: 25px;
      width: 100%;
      max-width: 500px;
      transition: transform 0.3s, box-shadow 0.3s;
      animation: fadeInUp 0.6s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.25);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .card input, .card button, .card textarea {
      width: 100%;
      padding: 12px 15px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .card input:focus, .card textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    .candidate {
      background: var(--light);
      margin-top: 10px;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      animation: fadeIn 0.5s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    .candidate:hover {
      background: #e5e7eb;
      transform: translateX(5px);
    }
    
    .candidate.selected {
      background: rgba(79, 70, 229, 0.1);
      border-left: 4px solid var(--primary);
    }
    
    .candidate-number {
      background: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-weight: bold;
    }
    
    .hidden { 
      display: none; 
    }
    
    .timer {
      font-weight: bold;
      font-size: 1.2rem;
      color: var(--warning);
      margin-top: 15px;
      text-align: center;
      animation: pulse 1.5s infinite;
    }
    
    .code-display {
      background: var(--light);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 3px;
      margin: 15px 0;
      animation: fadeIn 0.5s ease-out;
    }
    
    .result-bar {
      height: 30px;
      background: var(--light);
      border-radius: 15px;
      margin: 10px 0;
      overflow: hidden;
      position: relative;
    }
    
    .result-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 15px;
      transition: width 1s ease-out;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 15px;
      color: white;
      font-weight: bold;
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--primary);
      top: -10px;
      opacity: 0;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      color: var(--dark);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.4s ease-out;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left: 4px solid var(--success);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger);
    }
    
    .notification.warning {
      border-left: 4px solid var(--warning);
    }
    
    .floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
      animation: bounce 2s infinite;
    }
    
    .floating-btn:hover {
      transform: scale(1.1);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    .share-section {
      margin-top: 15px;
      padding: 15px;
      background: var(--light);
      border-radius: 10px;
      text-align: center;
    }
    
    .share-btn {
      background: var(--success);
      margin-top: 10px;
    }
    
    .qr-code {
      margin: 15px auto;
      width: 150px;
      height: 150px;
      background: white;
      padding: 10px;
      border-radius: 10px;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <h1>College Election Voting System</h1>

  <!-- Home Card -->
  <div class="card" id="home">
    <h2>Join or Create Election</h2>
    <button id="createRoomBtn">Generate New Code</button>
    <input type="text" id="joinCode" placeholder="Enter Code to Join">
    <button id="joinBtn">Join Election</button>
    <div class="share-section">
      <p><strong>Tip:</strong> Share the election code with voters</p>
    </div>
  </div>

  <!-- Host Setup -->
  <div class="card hidden" id="hostSetup">
    <h2>Host: Setup Election</h2>
    <p><strong>Share this code with voters:</strong></p>
    <div class="code-display" id="roomCodeDisplay"></div>
    
    <div class="share-section">
      <p>Share this election with others:</p>
      <button class="share-btn" id="shareLinkBtn">Copy Share Link</button>
      <div class="qr-code" id="qrCode">
        <p>QR Code Placeholder</p>
        <p>(In a real app, this would generate a QR code)</p>
      </div>
    </div>
    
    <input type="text" id="candidateName" placeholder="Add candidate name">
    <button id="addCandidateBtn">Add Candidate</button>
    <div id="candidateList"></div>
    <button id="startVotingBtn">Start Voting</button>
    <button id="morePostsBtn" class="hidden" style="margin-top: 15px; background: var(--warning);">Request More Posts</button>
  </div>

  <!-- Voter Page -->
  <div class="card hidden" id="voterPage">
    <h2>Vote Your Candidate</h2>
    <div id="voteCandidates"></div>
    <div class="timer" id="voteTimer"></div>
  </div>

  <!-- Host Result Page -->
  <div class="card hidden" id="hostResult">
    <h2>Voting Results</h2>
    <div id="results"></div>
    <button id="newElectionBtn" style="margin-top: 20px;">Start New Election</button>
  </div>

  <!-- More Posts Request Modal -->
  <div class="card hidden" id="morePostsModal">
    <h2>Request More Posts</h2>
    <p>Please describe why you need more posts for this election:</p>
    <textarea id="reasonText" rows="4" placeholder="Enter your reason here..."></textarea>
    <button id="submitRequestBtn">Submit Request</button>
    <button id="cancelRequestBtn" style="background: var(--danger); margin-top: 10px;">Cancel</button>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Floating action button for host -->
  <div class="floating-btn hidden" id="floatingActionBtn">
    <i>⚙️</i>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // ---------- IMPORTANT ----------
    // This app now uses Firestore for real-time, multi-device voting.
    // You MUST create a Firebase project, enable Firestore, and replace the firebaseConfig below.
    // Also set Firestore rules to secure rooms properly (see README or the instructions at the end of this file).
    // --------------------------------

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyA5T8KUr8Pd_-2IRyOt5H7d-cF4cqy3-mE",
      authDomain: "just-8f47d.firebaseapp.com",
      projectId: "just-8f47d",
      storageBucket: "just-8f47d.firebasestorage.app",
      messagingSenderId: "549636932164",
      appId: "1:549636932164:web:bf84d7d2eea29b4cbbf211",
      measurementId: "G-7XZFDTE05W"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Auth state tracking
    let authReady = false;
    let currentUid = null;

    // Disable buttons until auth is ready to avoid null uid errors
    createRoomBtn.disabled = true;
    joinBtn.disabled = true;

    // Sign in anonymously on page load and listen for state
    auth.onAuthStateChanged(user => {
      if (user) {
        authReady = true;
        currentUid = user.uid;
        // enable primary actions
        createRoomBtn.disabled = false;
        joinBtn.disabled = false;
        console.log('Signed in anonymously as', currentUid);
      } else {
        // attempt sign-in if signed out
        auth.signInAnonymously().catch(error => {
          console.error('Auth sign-in error:', error);
          showNotification('Authentication failed: ' + (error.message || error), 'error');
        });
      }
    });

    // DOM Elements
    const home = document.getElementById('home');
    const hostSetup = document.getElementById('hostSetup');
    const voterPage = document.getElementById('voterPage');
    const hostResult = document.getElementById('hostResult');
    const morePostsModal = document.getElementById('morePostsModal');

    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinBtn = document.getElementById('joinBtn');
    const addCandidateBtn = document.getElementById('addCandidateBtn');
    const startVotingBtn = document.getElementById('startVotingBtn');
    const morePostsBtn = document.getElementById('morePostsBtn');
    const newElectionBtn = document.getElementById('newElectionBtn');
    const submitRequestBtn = document.getElementById('submitRequestBtn');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    const floatingActionBtn = document.getElementById('floatingActionBtn');
    const shareLinkBtn = document.getElementById('shareLinkBtn');

    const joinCodeInput = document.getElementById('joinCode');
    const candidateName = document.getElementById('candidateName');
    const candidateList = document.getElementById('candidateList');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const voteCandidates = document.getElementById('voteCandidates');
    const voteTimer = document.getElementById('voteTimer');
    const results = document.getElementById('results');
    const reasonText = document.getElementById('reasonText');
    const notification = document.getElementById('notification');

    let currentRoom = null;
    let isHost = false;
    let timer = null;
    let selectedCandidate = null;
    let roomUnsubscribe = null; // Firestore listener unsubscribe

    // Utility: simple UUID v4 for host secret
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Generate unique 6-digit code (avoid collisions by checking Firestore)
    async function generateUniqueCode() {
      while (true) {
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        const doc = await db.collection('rooms').doc(code).get();
        if (!doc.exists) return code;
      }
    }

    function showNotification(message, type = 'success') {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function createConfetti() {
      const colors = ['#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
      }
    }

    // Attach real-time listener for a room
    function attachRoomListener(roomCode, onUpdate) {
      if (roomUnsubscribe) roomUnsubscribe();
      const docRef = db.collection('rooms').doc(roomCode);
      roomUnsubscribe = docRef.onSnapshot(snapshot => {
        if (!snapshot.exists) return;
        const data = snapshot.data();
        onUpdate(data);
      }, err => {
        console.error('Room listener error', err);
      });
    }

    // Initialize UI behaviors
    function initializeUI() {
      // Ripple effect kept from original
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', function(e) {
          const x = e.clientX - e.target.getBoundingClientRect().left;
          const y = e.clientY - e.target.getBoundingClientRect().top;
          const ripple = document.createElement('span');
          ripple.style.left = x + 'px';
          ripple.style.top = y + 'px';
          ripple.classList.add('ripple');
          this.appendChild(ripple);
          setTimeout(() => ripple.remove(), 600);
        });
      });

      // Check URL for room param
      const urlParams = new URLSearchParams(window.location.search);
      const roomCodeFromUrl = urlParams.get('room');
      if (roomCodeFromUrl) joinCodeInput.value = roomCodeFromUrl;
    }

    document.addEventListener('DOMContentLoaded', initializeUI);

    // CREATE ROOM - host
    createRoomBtn.onclick = async () => {
      try {
        if (!authReady || !currentUid) {
          showNotification('Authentication not ready — please wait a moment and try again.', 'warning');
          return;
        }
        createRoomBtn.disabled = true;
        const code = await generateUniqueCode();
        const hostSecret = uuidv4();
        const roomDoc = {
          candidates: [],
          votes: {},
          started: false,
          hostSecret: hostSecret,
          hostUid: currentUid, // Store host's UID
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          durationSeconds: 60,
          voters: {}
        };
        await db.collection('rooms').doc(code).set(roomDoc);

        currentRoom = code;
        isHost = true;
        // store host secret locally so only host can view results
        localStorage.setItem('hostSecret:' + code, hostSecret);
        roomCodeDisplay.textContent = code + ' (keep this secret)';

        home.classList.add('hidden');
        hostSetup.classList.remove('hidden');
        floatingActionBtn.classList.remove('hidden');
        showNotification('Election created. Share code with voters.', 'success');

        // Listen for updates
        attachRoomListener(code, data => {
          updateCandidateList(data.candidates || []);
          if (data.started) {
            // show voting page for host when voting started
            hostSetup.classList.add('hidden');
            voterPage.classList.remove('hidden');
            startTimer(data.durationSeconds || 60, data.startedAt ? data.startedAt.toMillis() : null);
            loadVotingCandidates(data.candidates || []);
          }
          // If voting ended and host, show results
          if (data.ended && isHost) showResultsFromData(data);
        });
      } catch (err) {
        console.error(err);
        showNotification('Failed to create election', 'error');
      } finally {
        createRoomBtn.disabled = false;
      }
    };

    // COPY SHARE LINK
    shareLinkBtn.onclick = () => {
      if (!currentRoom) return showNotification('Create a room first', 'error');
      const shareUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoom}`;
      navigator.clipboard.writeText(shareUrl).then(() => showNotification('Share link copied', 'success'))
        .catch(() => showNotification('Copy failed', 'error'));
    };

    // ADD CANDIDATE (host)
    addCandidateBtn.onclick = async () => {
      const name = candidateName.value.trim();
      if (!name) return showNotification('Enter candidate name', 'error');
      if (!currentRoom) return showNotification('No active room', 'error');
      try {
        addCandidateBtn.disabled = true;
        const roomRef = db.collection('rooms').doc(currentRoom);
        await roomRef.update({ candidates: firebase.firestore.FieldValue.arrayUnion(name) });
        candidateName.value = '';
        showNotification('Candidate added', 'success');
      } catch (err) {
        console.error(err);
        showNotification('Failed to add candidate', 'error');
      } finally { addCandidateBtn.disabled = false; }
    };

    function updateCandidateList(list) {
      candidateList.innerHTML = '';
      list.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = 'candidate';
        div.innerHTML = `<div class="candidate-number">${i+1}</div><div>${c}</div>`;
        candidateList.appendChild(div);
      });
    }

    // START VOTING (host)
    startVotingBtn.onclick = async () => {
      if (!currentRoom) return showNotification('Create a room first', 'error');
      try {
        startVotingBtn.disabled = true;
        const startedAt = firebase.firestore.Timestamp.now();
        const durationSeconds = 60; // configurable
        await db.collection('rooms').doc(currentRoom).update({ started: true, startedAt: startedAt, durationSeconds: durationSeconds, ended: false });
        showNotification('Voting started', 'success');
      } catch (err) {
        console.error(err);
        showNotification('Failed to start voting', 'error');
      } finally { startVotingBtn.disabled = false; }
    };

    // JOIN (voter)
    joinBtn.onclick = async () => {
      const code = joinCodeInput.value.trim();
      if (!code) return showNotification('Enter a room code', 'error');
      joinBtn.disabled = true;
      joinBtn.innerHTML = '<span class="loading"></span> Joining...';
      try {
        const doc = await db.collection('rooms').doc(code).get();
        if (!doc.exists) return showNotification('Room not found', 'error');
        const data = doc.data();
        if (!data.started) return showNotification('Voting has not started yet', 'warning');
        currentRoom = code; isHost = false;

        home.classList.add('hidden');
        voterPage.classList.remove('hidden');
        loadVotingCandidates(data.candidates || []);

        // Real-time updates for votes (so voters see live state if needed)
        attachRoomListener(code, updated => {
          // show vote counts to host only
          if (!isHost) return;
        });
        // Start timer aligned with server time if startedAt present
        startTimer(data.durationSeconds || 60, data.startedAt ? data.startedAt.toMillis() : null);
      } catch (err) {
        console.error(err);
        showNotification('Failed to join', 'error');
      } finally { joinBtn.disabled = false; joinBtn.innerHTML = 'Join Election'; }
    };

    // Load voting candidates into voter UI and bind click handlers
    function loadVotingCandidates(candidates) {
      voteCandidates.innerHTML = '';
      candidates.forEach(name => {
        const div = document.createElement('div');
        div.className = 'candidate';
        div.innerHTML = `<div>${name}</div>`;
        div.onclick = async () => {
          // disable further clicks locally
          voteCandidates.querySelectorAll('.candidate').forEach(el => el.style.pointerEvents = 'none');
          try {
            // Atomic increment using transaction with voter tracking
            if (!authReady || !currentUid) {
              showNotification('Authentication not ready — cannot submit vote yet.', 'warning');
              return;
            }
            const roomRef = db.collection('rooms').doc(currentRoom);
            const voterUid = currentUid;
            await db.runTransaction(async tx => {
              const roomSnap = await tx.get(roomRef);
              if (!roomSnap.exists) throw new Error('Room not found');
              const roomData = roomSnap.data();
              
              // Check if voting is open
              if (!roomData.started || roomData.ended) throw new Error('Voting closed');
              
              // Check if user already voted
              const voters = roomData.voters || {};
              if (voters[voterUid]) throw new Error('You have already voted');
              
              // Update votes and mark user as voted
              const votes = roomData.votes || {};
              const current = votes[name] || 0;
              votes[name] = current + 1;
              voters[voterUid] = true;
              
              tx.update(roomRef, { 
                votes: votes,
                voters: voters,
                totalVotes: firebase.firestore.FieldValue.increment(1)
              });
            });
            showNotification('Vote submitted', 'success');
          } catch (err) {
            console.error(err);
            showNotification('Failed to submit vote', 'error');
          }
        };
        voteCandidates.appendChild(div);
      });
    }

    // timer: if startedAtMillis provided, compute remaining relative to that timestamp
    function startTimer(seconds, startedAtMillis = null) {
      if (timer) clearInterval(timer);
      let endTime = Date.now() + seconds * 1000;
      if (startedAtMillis) {
        endTime = startedAtMillis + seconds * 1000;
      }
      function tick() {
        const msLeft = endTime - Date.now();
        const sLeft = Math.max(0, Math.ceil(msLeft / 1000));
        voteTimer.textContent = `Time left: ${sLeft}s`;
        if (sLeft <= 10) voteTimer.style.color = 'var(--danger)';
        if (msLeft <= 0) {
          clearInterval(timer); timer = null; voteTimer.textContent = 'Voting Closed!';
          // mark ended in Firestore (host will do this or we can set it here)
          if (isHost && currentRoom) {
            db.collection('rooms').doc(currentRoom).update({ ended: true }).catch(console.error);
          }
        }
      }
      tick();
      timer = setInterval(tick, 1000);
    }

    // Show results for host using data from Firestore
    function showResultsFromData(data) {
      voterPage.classList.add('hidden');
      hostResult.classList.remove('hidden');
      results.innerHTML = '';
      const votes = data.votes || {};
      const total = Object.values(votes).reduce((a, b) => a + b, 0);
      const entries = Object.entries(votes).sort((a, b) => b[1] - a[1]);
      entries.forEach(([name, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        const item = document.createElement('div');
        item.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${name}</span><span>${count} votes (${percentage}%)</span></div><div class='result-bar'><div class='result-fill' style='width:${percentage}%'>${percentage}%</div></div>`;
        results.appendChild(item);
      });
      if (entries.length > 0) createConfetti();
    }

    // New election
    newElectionBtn.onclick = () => {
      hostResult.classList.add('hidden');
      home.classList.remove('hidden');
      currentRoom = null; isHost = false;
      if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
    };

    // More posts request (keeps previous UX but stores flag in Firestore)
    morePostsBtn.onclick = () => { hostSetup.classList.add('hidden'); morePostsModal.classList.remove('hidden'); };
    submitRequestBtn.onclick = async () => {
      const reason = reasonText.value.trim(); if (!reason) return showNotification('Please provide a reason', 'error');
      if (!currentRoom) return showNotification('No active room', 'error');
      try {
        await db.collection('rooms').doc(currentRoom).update({ morePostsRequested: true, morePostsReason: reason });
        showNotification('Request submitted', 'success');
      } catch (err) { console.error(err); showNotification('Submit failed', 'error'); }
      morePostsModal.classList.add('hidden'); hostSetup.classList.remove('hidden'); morePostsBtn.classList.add('hidden');
    };
    cancelRequestBtn.onclick = () => { morePostsModal.classList.add('hidden'); hostSetup.classList.remove('hidden'); };

    // Floating action - switch back to host setup
    floatingActionBtn.onclick = () => {
      if (hostSetup.classList.contains('hidden')) {
        voterPage.classList.add('hidden'); hostResult.classList.add('hidden'); hostSetup.classList.remove('hidden');
      } else { hostSetup.classList.add('hidden'); home.classList.remove('hidden'); floatingActionBtn.classList.add('hidden'); }
    };

    // Helper: show results only if the local client has the host secret stored
    // (Client-side check — for production enforce rules in Firestore)
    async function tryShowResultsIfHost(code) {
      if (!code) return;
      const localSecret = localStorage.getItem('hostSecret:' + code);
      if (!localSecret) return; // not host on this device
      const doc = await db.collection('rooms').doc(code).get();
      if (!doc.exists) return;
      const data = doc.data();
      if (data.hostSecret === localSecret) {
        // grant host view
        isHost = true; currentRoom = code;
        showResultsFromData(data);
      }
    }

    // On load: if room param exists, try to show join code and host view
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const r = params.get('room');
      if (r) {
        // try to show host results if host secret exists
        await tryShowResultsIfHost(r);
      }
    })();
  </script>
</body>
</html>